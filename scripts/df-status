#!/bin/sh

# echos repo names & version info

basedir="$( cd -P "$( dirname "$0" )" && pwd )"/..

trap "exit 0" SIGINT

# clean up old jobs output
rm -rf /tmp/df-st-output
mkdir /tmp/df-st-output

# enable job control
set -m

checkstatus(){
    if [ -d ".hg" ]; then
        echo -e "\033[1m$1\033[0m `hg id -n`" | sed 's/\-e //' > /tmp/df-st-output/$1
        hg diff --stat >> /tmp/df-st-output/$1 2>&1 &
    else
        git status
    fi
}

cd $basedir
checkstatus dotfiles

for dir in `find . -mindepth 2 -maxdepth 2 -name '.hg' -o -name '.git' | cut -d / -f 2 | sort`; do
    cd $basedir/$dir
    name="`pwd | rev | cut -d / -f1 | rev`"
    checkstatus $dir
done

# wait for parallel jobs to finish
while [ 1 ]; do fg &> /dev/null; [ $? == 1 ] && break; done

# print output
cat /tmp/df-st-output/*
