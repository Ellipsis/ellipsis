#!/bin/sh

status() {
    name=$(echo "${1##*/}" | sed 's/^\.//')
    cd "$1"

    ahead=$(git status -sb --porcelain | grep --color=no -o '\[.*\]')
    has_changes=$(git status --untracked-files=no --porcelain 2> /dev/null | tail -n1)
    [[ "$ahead" = "" ]] && [[ "$has_changes" = "" ]] && return

    echo -e "\033[1m$name\033[0m $(git --no-pager log --pretty=format:'%h %ad' --abbrev-commit --date=relative -1) $ahead" | sed 's/\-e //'

    git --no-pager diff --stat --color=always
}

pull() {
    name=$(echo "${1##*/}" | sed 's/^\.//')
    cd "$1"

    echo -e "\033[1mupdating $name\033[0m" | sed 's/\-e //'

    git pull
}

push() {
    name=$(echo "${1##*/}" | sed 's/^\.//')
    cd "$1"

    echo -e "\033[1mpushing $name\033[0m" | sed 's/\-e //'

    git push
}

_do() {
    eval "${1}" $HOME/.ellipsis

    for module in $HOME/.ellipsis/modules/*; do
        if [ -e "$module/.ellipsis/$1" ]; then
            module_path=$module
            module=${module##*/}
            . "$module_path/.ellipsis/$1"
        fi
    done
}

case $1 in
    status|st)
        _do status
    ;;
    pull|update|up)
        _do pull
    ;;
    push)
        _do push
    ;;
    *)
        echo "Usage: ellipsis {push|pull|status}"
    ;;
esac
