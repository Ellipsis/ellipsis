#!/usr/bin/env python

import argparse
import codecs
import json
import os
import sys

PROFILE = '~/Library/Application Support/Firefox/Profiles/ah5u2jfa.default'

# set encoding for stdout
sys.stdout = codecs.getwriter('UTF-8')(sys.stdout)

class AttrDict(dict):
    def __getattr__(self, name):
        if name.startswith('_') or name == 'trait_names':
            raise AttributeError
        return self[name]


class Session(object):
    def __init__(self, data):
        self.data = data

    def itertabs(self):
        for window in self.data.windows:
            for tab in window.tabs:
                yield tab

    @property
    def tabs(self):
        return list(self.itertabs())


def load_session():
    with open(os.path.join(os.path.expanduser(PROFILE), 'sessionstore.js')) as f:
        return Session(json.load(f, object_hook=AttrDict))


def list_command(args=None):
    session = load_session()
    for tab in session.tabs:
        for entry in tab.entries:
            try:
                print entry.title, '-', entry.url
            except KeyError:
                pass

if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    subparsers = parser.add_subparsers()

    # list command
    list_parser = subparsers.add_parser('list', help='List open tabs')
    list_parser.set_defaults(command=list_command)

    if sys.argv[1:]:
        args = parser.parse_args()
        command = args.command
        command(args)
    else:
        list_command()
